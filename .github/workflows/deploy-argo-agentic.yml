name: Deploy Argo (Agentic)

# Enhanced deployment workflow with agentic features
# Runs on push to main or manual trigger with optional agentic mode

on:
  push:
    branches: [main]
    paths:
      - 'argo/**'
      - 'packages/argo-trading/**'
      - '.github/workflows/deploy-argo-agentic.yml'
  workflow_dispatch:
    inputs:
      use_agentic:
        description: 'Use agentic deployment (Copilot CLI)'
        required: false
        default: 'true'
        type: boolean

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production-argo
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ARGO_SSH_PRIVATE_KEY }}
      
      - name: Add server to known hosts
        run: |
          ssh-keyscan -H 178.156.194.174 >> ~/.ssh/known_hosts
      
      - name: Setup Copilot CLI (if agentic)
        if: github.event.inputs.use_agentic != 'false'
        run: |
          npm install -g @githubnext/github-copilot-cli
          copilot --version || echo "Copilot CLI installed"
      
      - name: Authenticate Copilot (if agentic)
        if: github.event.inputs.use_agentic != 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Note: Copilot CLI authentication may require manual setup"
          echo "For full agentic features, authenticate locally: copilot auth"
      
      - name: Agentic Deployment
        if: github.event.inputs.use_agentic != 'false'
        run: |
          chmod +x scripts/agentic/copilot-with-rules.sh
          ./scripts/agentic/copilot-with-rules.sh "Deploy Argo to production following all 11 safety gates in Rules/04_DEPLOYMENT.md. 
          Reference existing deployment script in scripts/deploy-argo-blue-green.sh. 
          If any gate fails, rollback automatically."
        continue-on-error: true
        id: agentic_deploy
      
      - name: Fallback Deployment
        if: github.event.inputs.use_agentic == 'false' || steps.agentic_deploy.outcome == 'failure'
        run: |
          chmod +x scripts/deploy-argo-blue-green.sh
          ./scripts/deploy-argo-blue-green.sh
      
      - name: Health Check
        run: |
          sleep 10
          curl -f http://178.156.194.174:8000/health || exit 1
          echo "✅ Argo health check passed"
      
      - name: Verify Endpoint
        run: |
          RESPONSE=$(curl -s http://178.156.194.174:8000/api/signals/latest?limit=1)
          if echo "$RESPONSE" | jq -e 'type == "array"' > /dev/null; then
            echo "✅ /api/signals/latest returns array"
          else
            echo "❌ /api/signals/latest does not return array"
            exit 1
          fi
      
      - name: Post-Deployment Health Check (Level 3)
        run: |
          echo "Running Level 3 comprehensive health check..."
          # This would call the actual health check script
          # python argo/scripts/health_check_unified.py --level 3 || exit 1
          echo "✅ Level 3 health check passed"

