# V6.0 Security Implementations - Complete Documentation

**Version:** 6.0  
**Date:** January 15, 2025  
**Status:** ✅ Production Ready

---

## Overview

Comprehensive documentation of all security implementations in V6.0. This includes all new security features, RBAC system, alerting, error handling, and more.

---

## Table of Contents

1. [RBAC System](#rbac-system)
2. [Security Event Alerting](#security-event-alerting)
3. [Standardized Error Responses](#standardized-error-responses)
4. [Resource Ownership Checks](#resource-ownership-checks)
5. [Webhook Security](#webhook-security)
6. [Log Rotation & Sampling](#log-rotation--sampling)
7. [Enhanced Rate Limiting](#enhanced-rate-limiting)
8. [CSRF Protection](#csrf-protection)
9. [Request Size Limits](#request-size-limits)
10. [Secret Validation](#secret-validation)

---

## RBAC System

### Overview

Role-Based Access Control (RBAC) system providing fine-grained authorization for the Alpine Backend.

### Components

- **Models:** `backend/models/role.py`
- **Utilities:** `backend/core/rbac.py`
- **API:** `backend/api/roles.py`
- **Migration:** `backend/migrations/add_rbac_tables.py`

### Features

- **Roles:** admin, moderator, support, user
- **Permissions:** Granular permission system (user:read, admin:write, etc.)
- **Database:** Full RBAC schema with associations
- **API:** Role management endpoints
- **Dependencies:** `require_permission()`, `require_role()`

### Usage Examples

**Check Permission:**
```python
from backend.core.rbac import require_permission, PermissionEnum

@router.get("/admin/users")
async def get_users(
    current_user: User = Depends(require_permission(PermissionEnum.ADMIN_USERS))
):
    ...
```

**Check Role:**
```python
from backend.core.rbac import require_role

@router.get("/admin/analytics")
async def get_analytics(
    current_user: User = Depends(require_role("admin"))
):
    ...
```

### Initialization

1. Run database migration:
   ```bash
   python migrations/add_rbac_tables.py
   ```

2. Initialize default roles:
   ```bash
   POST /api/v1/roles/initialize
   ```

### Documentation

**See:** [Rules/36_RBAC_AUTHORIZATION.md](../Rules/36_RBAC_AUTHORIZATION.md)

---

## Security Event Alerting

### Overview

Centralized security event alerting system with multi-channel support and threshold-based alerting.

### Components

- **Implementation:** `backend/core/alerting.py`
- **Integration:** `backend/core/security_logging.py`

### Features

- **Channels:** PagerDuty, Slack, Email
- **Thresholds:** Configurable per event type
- **Events:** Failed logins, rate limits, CSRF violations, unauthorized access, account lockouts
- **Automatic:** Integrated with security logging

### Configuration

```bash
SECURITY_ALERTS_ENABLED=true
PAGERDUTY_ENABLED=false
PAGERDUTY_API_KEY=your_key
SLACK_ENABLED=false
SLACK_WEBHOOK_URL=your_webhook
EMAIL_ALERTS_ENABLED=false
ALERT_EMAIL=alerts@example.com
```

### Alert Thresholds

- **Failed Login:** 5 attempts in 5 minutes
- **Rate Limit:** 10 violations in 1 minute
- **CSRF Violation:** 3 violations in 1 minute
- **Unauthorized Access:** 3 attempts in 5 minutes
- **Account Lockout:** Immediate alert

### Usage

Alerts are automatically triggered by security logging functions:
- `log_failed_login()` - Triggers alert on threshold
- `log_rate_limit_exceeded()` - Triggers alert on threshold
- `log_csrf_violation()` - Triggers alert on threshold
- `log_unauthorized_access()` - Triggers alert on threshold
- `log_account_locked()` - Immediate critical alert

---

## Standardized Error Responses

### Overview

Comprehensive standardized error response system with error codes, types, and request ID tracking.

### Components

- **Implementation:** `backend/core/error_responses.py`
- **Integration:** All API endpoints

### Features

- **Error Codes:** Standardized codes (AUTH_xxx, AUTHZ_xxx, etc.)
- **Error Types:** Categorized by type
- **Request ID:** Included in all responses
- **Field Names:** For validation errors
- **Details:** Additional error information

### Error Code Registry

**Authentication (AUTH_xxx):**
- `AUTH_001` - Invalid or expired token
- `AUTH_002` - Token blacklisted
- `AUTH_003` - Invalid credentials
- `AUTH_004` - Account locked
- `AUTH_005` - Account inactive
- `AUTH_006` - 2FA required
- `AUTH_007` - 2FA verification failed

**Authorization (AUTHZ_xxx):**
- `AUTHZ_001` - Insufficient permissions
- `AUTHZ_002` - Admin access required
- `AUTHZ_003` - Resource ownership required
- `AUTHZ_004` - Role not found

**Validation (VALIDATION_xxx):**
- `VALIDATION_001` - Invalid input format
- `VALIDATION_002` - Missing required field
- `VALIDATION_003` - Value out of range
- `VALIDATION_004` - Invalid email format
- `VALIDATION_005` - Invalid symbol format
- `VALIDATION_006` - Password too weak

**Rate Limiting (RATE_xxx):**
- `RATE_001` - Rate limit exceeded

**CSRF (CSRF_xxx):**
- `CSRF_001` - CSRF token missing
- `CSRF_002` - CSRF token mismatch
- `CSRF_003` - Origin not allowed

**Resource (RESOURCE_xxx):**
- `RESOURCE_001` - Resource not found
- `RESOURCE_002` - Resource already exists
- `RESOURCE_003` - Resource conflict

**Server (SERVER_xxx):**
- `SERVER_001` - Internal server error
- `SERVER_002` - Service unavailable
- `SERVER_003` - Database error
- `SERVER_004` - External service error

**Request (REQUEST_xxx):**
- `REQUEST_001` - Request body too large
- `REQUEST_002` - Invalid content type
- `REQUEST_003` - Malformed request

### Usage

```python
from backend.core.error_responses import create_error_response, ErrorCodes

raise create_error_response(
    ErrorCodes.AUTHZ_001,
    "Insufficient permissions",
    status_code=403,
    request=request
)
```

### Response Format

```json
{
  "error": {
    "code": "AUTHZ_001",
    "message": "Insufficient permissions",
    "type": "authorization_error",
    "field": null,
    "details": null
  },
  "request_id": "uuid-here"
}
```

---

## Resource Ownership Checks

### Overview

Middleware and utilities for verifying resource ownership to prevent unauthorized access.

### Components

- **Implementation:** `backend/core/resource_ownership.py`
- **Integration:** User-specific endpoints

### Features

- **Ownership Verification:** Check if user owns resource
- **Automatic Logging:** Log unauthorized access attempts
- **Standardized Errors:** Return 403 Forbidden with error code
- **Dependency Factory:** Easy endpoint integration

### Usage

**As Dependency:**
```python
from backend.core.resource_ownership import verify_resource_ownership

@router.get("/signals/{signal_id}")
async def get_signal(
    signal_id: int,
    signal: Signal = Depends(verify_resource_ownership(
        Signal, "user_id", "signal_id"
    )),
    current_user: User = Depends(get_current_user)
):
    return signal
```

**In Code:**
```python
from backend.core.resource_ownership import verify_resource_ownership

signal = await verify_resource_ownership(
    resource_id=signal_id,
    resource_model=Signal,
    user_id_field="user_id",
    current_user=current_user,
    db=db
)
```

---

## Webhook Security

### Overview

Idempotency and replay attack prevention for webhook endpoints.

### Components

- **Implementation:** `backend/api/webhooks.py`
- **Features:** Idempotency, replay protection, timestamp validation

### Idempotency

- **Storage:** Redis-based (24-hour TTL)
- **Check:** Before processing webhook
- **Mark:** After successful processing
- **Fallback:** In-memory if Redis unavailable

### Replay Protection

- **Validation:** Event timestamp validation
- **Window:** 5-minute maximum age
- **Rejection:** Events older than window rejected
- **Logging:** Replay attempts logged as security events

### Usage

```python
# Automatic in webhook handler
@router.post("/stripe")
async def stripe_webhook(request: Request, ...):
    # Idempotency check
    if check_webhook_idempotency(event_id):
        return {"status": "success", "idempotent": True}
    
    # Timestamp validation
    if not validate_webhook_timestamp(event_created):
        raise HTTPException(400, "Event too old")
    
    # Process webhook
    ...
    
    # Mark as processed
    mark_webhook_processed(event_id)
```

---

## Log Rotation & Sampling

### Overview

Log rotation to prevent disk space issues and log sampling for high-volume endpoints.

### Log Rotation

**Implementation:** `backend/core/security_logging.py`

**Features:**
- **Size-based:** 10MB per file, 5 backup files
- **Time-based:** Daily rotation, 30 days retention
- **Handler:** `RotatingFileHandler`

### Log Sampling

**Implementation:** `backend/core/request_logging.py`

**Features:**
- **Health Checks:** 1% sampling
- **Metrics:** 10% sampling
- **Errors:** Always logged (status >= 400)
- **Security Events:** Always logged

**Configuration:**
```python
SAMPLING_RATES = {
    "/health": 0.01,  # 1%
    "/metrics": 0.10,  # 10%
}
```

---

## Enhanced Rate Limiting

### Overview

Production-ready rate limiting with fail-closed behavior and standardized errors.

### Features

- **Fail-Closed:** Reject requests if Redis fails (production)
- **Fail-Open:** Allow requests if Redis fails (development)
- **Standardized Errors:** Use `create_rate_limit_error()`
- **Headers:** Rate limit headers in all responses

### Configuration

**Production:**
- Fail-closed if Redis unavailable
- Reject requests for safety

**Development:**
- Fail-open if Redis unavailable
- Allow testing without Redis

### Usage

All endpoints automatically use rate limiting via `check_rate_limit()`.

---

## CSRF Protection

### Overview

Enhanced CSRF protection with origin validation.

### Features

- **Origin Validation:** Check against allowed origins
- **Token Validation:** CSRF token verification
- **Logging:** CSRF violations logged and alerted
- **Configuration:** Use settings for allowed origins

### Configuration

```python
ALLOWED_ORIGINS = [
    settings.FRONTEND_URL,
    "http://localhost:3000",
    "https://91.98.153.49:3000",
]
```

---

## Request Size Limits

### Overview

Request body size limits to prevent DoS attacks.

### Implementation

**Location:** `backend/main.py` - `RequestSizeLimitMiddleware`

**Features:**
- **Limit:** 10MB maximum
- **Check:** Content-Length header
- **Response:** 413 Payload Too Large
- **Position:** First middleware (before processing)

---

## Secret Validation

### Overview

Enhanced secret validation with default/weak secret detection.

### Features

- **Default Detection:** Detect default secret values
- **Weak Detection:** Detect common weak secrets
- **Fail-Fast:** Fail in production on validation failure
- **Warnings:** Warn in development

### Validation Rules

- JWT_SECRET must be at least 32 characters
- Reject default values: "change_me", "secret", "password", etc.
- Reject weak values: "argo_secret_key_change_in_production", etc.
- Fail fast in production
- Warn in development

---

## Testing

### Integration Tests

**Location:** `tests/integration/test_security_fixes.py`

**Coverage:**
- Admin endpoint security
- Resource ownership
- Rate limiting
- CSRF protection
- Request size limits
- Error response format
- Webhook idempotency
- RBAC
- Security alerting

### Verification Script

**Location:** `verify_security_implementation.py`

**Usage:**
```bash
cd alpine-backend
python verify_security_implementation.py
```

---

## Deployment

### Prerequisites

1. Run database migration:
   ```bash
   python migrations/add_rbac_tables.py
   ```

2. Initialize RBAC roles:
   ```bash
   POST /api/v1/roles/initialize
   ```

3. Configure alerting:
   - Set environment variables
   - Configure PagerDuty/Slack/Email

4. Verify implementation:
   ```bash
   python verify_security_implementation.py
   ```

### Environment Variables

```bash
# Security Alerting
SECURITY_ALERTS_ENABLED=true
PAGERDUTY_ENABLED=false
PAGERDUTY_API_KEY=
SLACK_ENABLED=false
SLACK_WEBHOOK_URL=
EMAIL_ALERTS_ENABLED=false
ALERT_EMAIL=

# Database
DATABASE_URL=postgresql://...

# Redis
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=...
```

---

## Related Documentation

- [Rules/07_SECURITY.md](../Rules/07_SECURITY.md) - Security rules
- [Rules/36_RBAC_AUTHORIZATION.md](../Rules/36_RBAC_AUTHORIZATION.md) - RBAC rules
- [Rules/26_API_DESIGN.md](../Rules/26_API_DESIGN.md) - API design
- [Rules/29_ERROR_HANDLING.md](../Rules/29_ERROR_HANDLING.md) - Error handling
- [Rules/14_MONITORING_OBSERVABILITY.md](../Rules/14_MONITORING_OBSERVABILITY.md) - Monitoring

---

## Status

✅ **All implementations complete and production-ready**

- ✅ RBAC System
- ✅ Security Event Alerting
- ✅ Standardized Error Responses
- ✅ Resource Ownership Checks
- ✅ Webhook Security
- ✅ Log Rotation & Sampling
- ✅ Enhanced Rate Limiting
- ✅ CSRF Protection
- ✅ Request Size Limits
- ✅ Secret Validation

